{% extends "base.html" %}

{% block title %}Your Shopping Cart{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">Your Shopping Cart</h2>
    {% if cart_items %}
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th style="width: 50%;">Product</th>
                        <th class="text-center">Price</th>
                        <th class="text-center" style="width: 15%;">Quantity</th>
                        <th class="text-end">Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                        {% if item.product %}
                        <tr id="item-row-{{ item.id }}">
                            <td>{{ item.product.name }}</td>
                            <td class="text-center">${{ "%.2f"|format(item.product.price) }}</td>
                            <td class="text-center">
                                <div class="input-group justify-content-center">
                                    <button class="btn btn-outline-secondary btn-sm quantity-change" data-id="{{ item.id }}" data-change="-1">-</button>
                                    <input type="text" class="form-control form-control-sm text-center" value="{{ item.quantity }}" readonly style="max-width: 60px;">
                                    <button class="btn btn-outline-secondary btn-sm quantity-change" data-id="{{ item.id }}" data-change="1">+</button>
                                </div>
                            </td>
                            <td class="text-end fw-bold" id="item-total-{{ item.id }}">
                                ${{ "%.2f"|format(item.product.price * item.quantity) }}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-danger remove-item" data-id="{{ item.id }}"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="row justify-content-end mt-4">
            <div class="col-md-4 text-end">
                <h3>Total: <span id="grand-total">${{ "%.2f"|format(total_price) }}</span></h3>
                <div class="d-grid">
                    <a href="{{ url_for('checkout') }}" class="btn btn-primary btn-lg mt-2">Proceed to Checkout</a>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            Your cart is empty. <a href="{{ url_for('index') }}" class="alert-link">Continue shopping!</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Весь JavaScript для управления корзиной
$(document).ready(function() {

    function updateCart() {
        window.location.reload();
    }

    // Обработчик для кнопок +/-
    $('.quantity-change').on('click', function() {
        const button = $(this);
        const itemId = button.data('id');
        const change = parseInt(button.data('change'));
        const quantityInput = button.siblings('input');
        let newQuantity = parseInt(quantityInput.val()) + change;

        if (newQuantity < 1) {
            newQuantity = 1; // Не позволяем уйти в ноль кнопкой "-"
        }

        $.ajax({
            url: `/api/cart/item/${itemId}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ quantity: newQuantity }),
            success: function(response) {
                if (response.success) {
                    updateCart(); // Перезагружаем страницу, чтобы обновить итоги
                }
            }
        });
    });

    // Обработчик для кнопки удаления
    $('.remove-item').on('click', function() {
        if (!confirm("Are you sure you want to remove this item?")) {
            return;
        }
        const itemId = $(this).data('id');

        $.ajax({
            url: `/api/cart/item/${itemId}`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    updateCart();
                }
            }
        });
    });
});
</script>
{% endblock %}